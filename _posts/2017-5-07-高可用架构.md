---
layout:     post
title:      高可用架构设计
subtitle:   如何设计一个高可用的架构？
date:       2017-05-07
author:     Joker
header-img: img/post-bg-debug.png
catalog: true
tags:
    - 大型网站
    - 架构
    - 高可用
---

* 部署多台应用逻辑层，通过负载均衡保证在其中几台宕机后另外几台可以继续提供服务
* 数据层至少保证2个以上，一个作为主数据，另一个做备份，当其中一个出现问题时切换到备份数据库

***

## 应用服务器集群下的session

> 方法

* session复制 （实现简单，不适合大量数据）
* session绑定 （在用户使用期间将session与固定服务器绑定）
* cookie记录session
* session服务器

***

## 高可用的服务（服务层）

* 分级管理（将服务按级别进行分类）
* 超时设置（对于超时的请求应该抛出异常，发起请求一放根据策略判断）
* 异步调用
* 服务降级（拒绝部分服务，关闭不重要服务）
* 幂等性设计（应用层请求服务，服务实际成功调用，但是因为网络通信原因导致应用层没收到成功消息，再次请求服务可能会导致服务出现异常，所以要在服务层进行幂等性设计）

***

## 高可用的数据

> 总述

* 整个网站共享一个较大的缓存服务器集群

> 方法

* CAP原理

  `三者在一定程度上不能同事满足，一般大型网站系统会舍弃数据一致性`

  * 数据持久性
  * 数据可访问性
  * 数据一致性
    * 数据强一致
    * 数据用户一致（一般达到这个等级）
    * 数据最终一致

* 数据备份

  * 冷备份
  * 热备份
    * 异步
      * 在完成数据写入主数据库中后直接返回结果并写入从数据库
    * 同步
      * 完成所有数据库更新操作后在返回结果（性能与异步差不多）

* 失效转移

  * 失效确认
  * 访问转移
  * 数据恢复

***

## 高可用软件质量保证

* 网站发布
* 自动化测试
* 预发布验证（与实际环境相同的情况下预发布）
* 代码控制
  * 主干发布，分支开发
  * 主干开发，分支发布
* 自动化发布
* 灰度发布

***

## 网站运行监控

> 监控数据采集

* 用户行为日志收集
  * 服务器端日志收集
  * 客户端日志收集
* 服务器性能监控
* 运行数据报告

> 监控管理

* 系统报警
* 失效转移
* 自动优雅降级

***